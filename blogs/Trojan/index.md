---
title: "软件与系统安全笔记(8) - 木马"
date: 2024-06-08
draft: false
description: "软件与系统安全笔记(8) - 木马"
tags: ["软件与系统安全"]
---
 <u>**软件与系统安全笔记(8) - 木马**</u>

------

## 木马



### 木马分类

**破坏型**

旨在直接对受感染的计算机系统造成损害，如删除或篡改文件，格式化硬盘，或使系统变得不稳定，无法正常运行。

**密码发送型**

专门设计用于窃取用户的登录凭证，如网上银行密码、社交账户信息等，并将这些信息发送给攻击者。

**远程访问型**

给予攻击者对受害者计算机的完全控制权，允许他们执行任意命令、浏览文件、监控屏幕、激活摄像头和麦克风等，如同亲自操作该电脑一样。

**键盘记录木马**

记录受害者的键盘输入，常用于窃取登录凭据、信用卡信息等敏感数据，是密码盗窃的一种具体形式。

**Dos攻击木马**

这类木马将受感染的计算机转变为“僵尸网络”的一部分，协同发起拒绝服务攻击，淹没目标服务器或网络，使其无法响应合法请求。

**代理木马**

将受害者的计算机变为攻击者的代理服务器，用来隐藏攻击者的真实身份，进行匿名上网或进一步的恶意活动。

**FTP木马**

创建一个FTP服务器在受害者的计算机上，使得攻击者能够通过FTP协议自由上传和下载文件，便于植入更多恶意代码或窃取数据。

**程序杀手木马**

能够终止或禁用特定的系统进程或安全软件（如防病毒软件），以降低系统的防御能力，便于其他恶意软件的渗透和活动。

**反弹端口木马**

传统木马需要攻击者主动向被控制计算机上的木马程序发起连接，而反弹端口型木马是被控计算机上的木马向攻击者发起连接，可以用于绕过防火墙等安全软件。



### 木马特点

**有效性**

指木马必须能够成功完成其设计的恶意任务，无论是窃取数据、控制系统还是执行其他恶意行为，有效性是衡量木马是否达到其目的的基本标准。

**隐蔽性**

这是木马的核心特征之一，它必须能够在不引起用户或安全软件警觉的情况下潜伏、运行和传播。这通常通过模仿正常程序的行为、隐藏自身文件或进程、修改系统设置等方式实现。

**顽固性**

指木马难以被发现和清除的特性。一些木马会自我复制、修改注册表项、备份自身到多个位置或在系统启动时自动加载，以确保即使部分被删除也能重新激活。

**易植入性**

木马设计要便于通过多种渠道传播，如电子邮件附件、恶意下载链接、社交媒体、软件捆绑等，易于诱导用户无意中下载安装。

**自动运行**

确保木马能在操作系统启动时自动执行，无需用户干预，这是确保其持久驻留和执行恶意活动的关键。

**欺骗性**

木马通常会伪装成有用的、合法的或吸引人的程序，如游戏外挂、系统更新通知、安全扫描工具等，以此欺骗用户下载安装。

**自动恢复**

即使被发现或部分移除，木马能够通过自我修复或重新下载机制恢复，增加清除难度，保持其在系统中的存在。

**功能的特殊性**

不同的木马可能专注于特定的恶意行为，如密码窃取、远程控制、数据加密（勒索软件）、DDoS攻击等，这些特殊功能使得木马能够针对特定目标或需求定制，提高攻击效率。



### 木马实现原理

木马程序是**一对**C/S程序的组合：

- **一个攻击者控制的客户端程序**
- **一个运行在被控主机上的服务端程序**

利用木马实现入侵需要完成以下环节：

1. **向目标主机植入服务端程序**

   攻击者首先需要将服务端程序安装到目标计算机上。这可以通过多种途径实现，包括但不限于：电子邮件附件、恶意下载链接、软件捆绑、社交媒体诈骗、利用系统漏洞或弱口令入侵等。

2. **启动和隐藏服务端程序**

   为了逃避检测和延长存活时间，木马会在受害者的系统中自我启动，并采取各种隐蔽手段，如修改注册表、隐藏文件、进程名伪装、躲避反病毒软件检测等，以确保在系统重启后仍能继续运行且不被轻易发现。

3. **服务端和客户端建立连接**

   一旦服务端在目标主机上激活并隐藏好自己，它就会尝试与攻击者控制的客户端建立连接。这可能通过直接连接到攻击者的服务器，或者采用更复杂的反弹端口技术，让受感染的机器主动向攻击者发起连接，从而绕过防火墙限制。

4. **在客户端进行远程控制**

   连接建立后，攻击者就可以通过客户端发送指令至服务端，实现对目标计算机的全面控制。这包括但不限于文件管理、屏幕监控、键盘记录、摄像头和麦克风控制、执行系统命令、下载和上传文件、以及发起进一步的攻击等。



### 植入技术

木马植入技术分为**主动植入**和**被动植入**两种。

主动植入：攻击者直接、主动地将木马程序部署到目标计算机上。

被动植入：攻击者设置好陷阱，等待受害者自行触发的过程。



**主动植入**

- 主动植入，一般需要通过某种方法获取目标主机的一定权限，然后由攻击者自己动手进行安装。

- 按照目标系统是本地还是远程的区分，这种方法又有**本地安装**与**远程安装**之分。
- 在一个系统植入木马，不仅需要将木马程序上传到目标系统，还需在目标系统运行木马程序;故主动植入不仅需要具有目标系统的写权限，还需要可执行权限。如果仅具有写权限，只能将木马程序上传但不能执行， 这种情况属于被动植入，因为木马仍需被动等待以某种 方式被执行

**主动植入 —— 本地安装**

直接在本地主机上进行木马安装。一些公用计算机或网吧计算机经常更换使用者，使得安装木马更容易奏效。

**主动植入 —— 远程安装**

通过常规攻击手段获得目标主机的一定权限后，将木马上传到目标主机上，并使其运行。

**远程安装 —— 利用系统自身漏洞植入**：

攻击者利用操作系统或应用程序中存在的未修复的安全漏洞（零日漏洞或已知但未广泛修复的漏洞），通过精心构造的数据包或代码，远程触发这些漏洞，以获得对目标系统的未授权访问。一旦获得访问权限，攻击者便可以上传木马程序，并执行必要的命令来启动木马。

**远程安装 —— 利用第三方软件漏洞植入**：

除了操作系统，许多计算机上安装的第三方应用（如办公软件、浏览器插件、PDF阅读器等）也可能存在安全漏洞。攻击者会密切关注这些软件的公告和漏洞数据库，利用未打补丁的漏洞，通过恶意网页、电子邮件附件或伪装的软件更新等方式，将木马与漏洞利用代码一并送达目标系统，进而植入木马。



**被动植入**

被动植入技术的特点在于，它更多依赖于目标用户的行为和疏忽，而不是直接的系统侵入。通过创造吸引用户交互的场景，木马得以在用户不知情的情况下被激活。因此，提高用户的安全意识、不随意点击不明链接或下载来源不明的文件，是防范此类木马植入的关键。

- **网页浏览植入**

攻击者通过在合法或被黑的网站上嵌入恶意代码（如JavaScript、恶意iframe或利用浏览器漏洞的exploit），当用户访问这些页面时，木马会自动下载并执行，或者诱导用户下载并安装伪装成安全更新、插件或有趣内容的恶意软件。

- **程序捆绑或类型伪装**

将木马与合法软件捆绑在一起，或将其伪装成用户可能感兴趣的文件类型（如文档、图片、视频等），当用户下载并打开这些文件时，木马随之激活。

- **利用电子邮件植入**

通过垃圾邮件或鱼叉式钓鱼邮件，将木马作为附件发送，或在邮件中嵌入带有恶意链接的文本或图片，诱导收件人点击下载或访问，从而植入木马。

- **利用网络下载植入**

在P2P分享网络、不受信任的下载站点或论坛上传带毒的热门软件、电影、游戏等资源，用户在下载和安装这些伪装成合法内容的文件时，木马被一并安装。

- **利用即时通讯工具植入**

通过即时通讯软件（如QQ、微信、Skype等）发送含有恶意链接的消息或文件，利用用户对联系人的信任来传播木马。

- **利用移动存储设备植入**

在U盘、移动硬盘等移动存储设备上预置自动运行脚本或伪装成重要文档的木马程序，当这些设备插入到计算机并被用户打开查看时，木马自动执行。



### 自动加载技术

- **修改系统文件**

木马替换或修改系统关键文件，如系统启动时会调用的exe或dll文件，使得木马代码随系统启动自动执行。

- **修改系统注册表**

通过修改Windows注册表中的自启动键值（如`HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run`或`HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`），使得木马程序在每次系统启动时自动运行。

- **添加系统服务**

创建新的系统服务或将木马自身注册为现有服务的一部分，木马可以在系统后台以高权限级别自动启动。

- **修改文件打开关联属性**

通过修改文件类型关联，使得当用户打开特定类型的文件（如文本文件或图片）时，实际上激活木马程序。

- **修改任务计划**

在Windows的任务计划中设置定时任务，让木马在预定时间自动执行，或在用户登录时启动。

- **修改组策略**

通过修改组策略设置（Group Policy），在域环境中可以使木马在所有受策略影响的计算机上自动运行。

- **修改启动文件夹**

将木马快捷方式或可执行文件放置在Windows启动文件夹（如`C:\Users\[用户名]\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup`），这样用户登录时木马就会自动启动。

- **利用系统自动运行的程序**

绑定或注入到Windows资源管理器、浏览器或其他经常自动启动的程序中，木马随着这些程序的启动而启动。

- **替换系统DLL**

替换系统动态链接库文件，当依赖这些DLL的程序运行时，实际上执行的是木马代码。



### 隐藏技术

隐蔽性是木马的生命，是木马程序 与其它程序的重要区别。木马想要在目标主机上存活，必须注意隐藏自己，使自身不被主机合法用户所发现。对木马服务端的隐藏可以是**伪隐藏**，也可以是**真隐藏**。

**伪隐藏**：程序的进程仍然存在，只不过是让它消失在进程列表里。

**真隐藏**：让程序彻底的消失，不以一个进程或者服务的方式工作。

- **设置窗口不可见**（从任务栏隐藏）

通过编程技术使木马运行时不显示任何窗口或图标，从而在用户界面层面隐藏其存在。这是从任务栏中隐藏木马的基本手段，使得用户在日常操作中难以觉察到木马程序的运行。

- **把木马程序注册为服务**（从进程隐藏）

将木马伪装或附加到系统服务中，使其作为合法服务的一部分自动启动并在后台运行。这种技术不仅确保木马随系统启动，还能在进程列表中以合法服务的名义出现，避免引起怀疑。

- **欺骗查看进程的函数**（从进程隐藏）

利用API钩子、Hook技术或修改系统调用来干扰或篡改进程查看工具的结果，使木马进程在如任务管理器等工具中不可见，从而在进程列表中隐藏。

- **使用可变的高端口**（端口隐藏）

木马在与控制端通信时选择不常用的高端口，或频繁更改通信端口，以避开常规端口扫描和防火墙规则，实现端口隐藏。

- **使用系统服务端口**（端口隐藏）

更进一步的，木马可能利用系统默认开放的端口（如80, 443等）进行通信，因为这些端口通常不会被防火墙封锁，从而更难被识别和阻止，这也是端口隐藏技术的一种。

- **替换系统驱动或系统DLL**（真隐藏）

通过替换或注入到系统核心组件中，如驱动程序或动态链接库(DLL)，木马可以深入系统底层，实现真隐藏，极难被发现和移除。这种方式下，木马成为系统运行不可或缺的一部分，即使安全软件也很难识别其恶意行为。

- **动态嵌入技术**（真隐藏）

这是一种高级隐藏技术，木马不以固定的文件形式存在，而是动态地嵌入到其他进程的内存空间中运行，或利用内存映射文件等技术在系统中不留明显痕迹，进一步增加检测难度。



### 连接技术

建立连接时，木马的服务端会在目标主机上打开一个默认的端口进行侦听(Listen)，如果有客户机向服务器端口提出连接请求(Connect Request)，服务器上的相关程序(木马服务器端)就会自动运行，并启动一个守护进程来应答客户机的各种请求

**端口侦听**：木马服务端（位于被感染的目标主机上）首先会在系统中选定一个或几个端口（可能是固定端口，也可能是随机选择的高端口），并设置为侦听状态。这意味着服务端程序会持续监控这些端口，等待来自客户端的连接请求。选择端口时，木马可能会尝试使用不常见的端口号，以减少被防火墙或安全软件拦截的概率。

**连接请求**：攻击者通过客户端程序（控制端），知道服务端的IP地址和开放的端口号后，会向这些地址和端口发出连接请求。这一步骤通常发生在攻击者想要与受控主机建立通信，下达指令或提取数据时。

**连接建立**：当客户端的连接请求到达服务端所在主机并被正确识别后，服务端的木马程序会自动响应这一请求，建立起一个双向通信的连接。此时，服务端通常会启动一个守护进程（后台服务），专门负责处理来自客户端的命令和数据传输。

**数据交换与命令执行**：一旦连接建立，攻击者就能通过客户端发送控制命令或下载/上传数据请求给服务端。服务端的守护进程接收到命令后，会按照命令执行相应的操作，如窃取文件、执行系统命令、修改系统设置、上传额外的恶意代码等。

**连接结束与隐藏**：完成指定操作后，连接可能被木马程序自动关闭，以减少被发现的风险。同时，服务端程序会继续保持隐蔽状态，等待下一次连接请求的到来



### 监控技术

木马在客户端端口和服务器端口之间建立连接后，木马客户端程序由该连接与木马服务器端程序联系，并对其进行远程控制：

1. **获取目标机器信息**：木马能够收集并发送目标计算机的详细系统信息给攻击者，包括但不限于操作系统类型及版本、硬件配置、已安装软件列表、网络配置、系统用户名和密码散列等。这些信息有助于攻击者评估目标系统的价值，选择进一步的攻击路径，或利用特定漏洞。
2. **记录用户事件**：木马具有键盘记录功能，能够记录用户敲击的每一个按键，包括账号密码、聊天记录、电子邮件内容等敏感信息。此外，它还可以捕获屏幕截图、监控摄像头和麦克风，记录用户的视觉和音频活动，全方位监视用户的行为。这些数据被收集并定期发送给攻击者，用于窃取隐私信息或进行进一步的攻击计划。
3. **远程操作**：通过木马建立的连接，攻击者可以远程控制目标计算机执行各种操作，如文件管理（查看、上传、下载、修改、删除文件）、进程管理（启动、停止系统进程）、注册表编辑、服务控制、命令行执行等。这种能力让攻击者几乎能够像坐在目标计算机前一样操作，进行各种恶意活动，如植入更多恶意软件、盗取重要数据、操纵系统行为，甚至使用目标计算机作为跳板攻击其他系统。



### 木马实例

- **Back Orifice**

**简介**：Back Orifice是由黑客组织Cult of the Dead Cow (cDc)在1998年发布的，主要针对微软Windows操作系统。这个名字是对微软的系统管理工具“BackOffice”的戏谑。BO是一款功能强大的远程管理工具，但被设计用来作为非法入侵和控制他人计算机的木马。

**功能**：BO允许攻击者远程控制被感染的计算机，包括但不限于文件管理、屏幕监控、键盘记录、摄像头控制、执行任意命令等。它通过隐蔽性强的手段，如修改注册表、自我复制和动态改变端口来躲避检测。

**影响**：BO的发布引起了广泛的关注，因为它展示了个人计算机安全的脆弱性，促进了公众对个人电脑安全防护意识的提高，并促使软件开发商更加重视安全问题。

- **SubSeven**

**简介**：SubSeven是一款出现在2002年的远程管理工具/木马，它同样针对Windows平台，以其强大的功能和易用性在黑客社区中流行。

**功能**：SubSeven提供了比Back Orifice更广泛的远程控制能力，包括但不限于文件管理、屏幕监控、键盘记录、摄像头和麦克风控制、系统信息收集、密码窃取、远程桌面控制等。它还支持通过IRC（互联网中继聊天）进行命令控制，增强了隐蔽性和控制的灵活性。

**影响**：SubSeven因其高度的可定制性和用户友好的控制界面，成为了恶意用户广泛使用的工具，加剧了个人和企业电脑安全的威胁。它的出现促使了网络安全软件对木马检测能力的进一步提升。

- **国产冰河**

**简介**：冰河是国内开发的一款远程控制软件，最初设计为合法的远程管理工具，但因其强大的功能被滥用为木马，广泛流传于2000年代中期。

**功能**：冰河提供了全面的远程控制能力，包括但不限于文件操作、进程管理、注册表操作、屏幕监控、键盘记录、摄像头和音频监控、远程命令执行等。它还采用了自定义加密通信和灵活的配置选项，提高了隐蔽性。

**影响**：冰河因其在国内的广泛传播，对个人用户和企业的信息安全构成了严重威胁。它促使国内网络安全行业对本土化木马的研究与防护技术的发展，提升了对木马防御的重视程度，并促进了相关法律法规的制定和完善。



### 木马的防御技术

**木马的检测**

1. **端口扫描和连接检查**：木马为了与攻击者进行通信，往往会占用特定的端口。通过定期扫描系统开放的端口，尤其是那些不常见的或未授权的端口活动，可以发现潜在的木马活动。此外，检查系统中的网络连接，识别出与可疑IP地址或域名的异常连接，也是发现木马的有效方法。
2. **检查系统进程**：木马运行时会在系统中生成进程。通过任务管理器或专门的进程监控工具，检查系统中运行的所有进程，特别是那些未知的、异常命名或消耗大量资源的进程，可以揭示木马的存在。此外，分析进程的依赖关系和父进程，也能帮助追踪木马的源头。
3. **检查ini文件、注册表和服务**：木马为了实现自启动，常常会修改ini文件（旧版Windows系统中）、注册表键值或创建系统服务。通过细致检查这些位置的改动，特别是新添加的启动项、修改的键值或异常的服务，可以帮助识别木马的自启动机制和位置。
4. **监视网络通讯**：通过网络监控软件或防火墙日志，分析进出的网络流量和数据包，可以发现木马的通信模式。特别注意那些加密的、异常的或频繁的对外连接，它们可能是木马与控制服务器的通信。网络监控还能揭示木马尝试外传数据的企图，如个人信息或敏感文件的泄露。

**木马的清除与善后**

知道了木马的加载位置后，首先要做的是将木马登记项删除，使得木马无法在开机时启动

有些木马进程会监视注册表，一旦注册表项被删除， 它立即恢复回来。因此，在删除前需停止木马进程，然后根据木马登记的目录将相应的木马程序删除

随着木马实现技术不断进步，很多木马带有自我保护机制，木马类型不断变化，因此，不同木马需要有针对性的清除方法

对于普通用户来说，最好借助专业杀毒软件或木马清除软件来清除木马。安装优秀的杀病毒和防火墙软件并定期升级，不失为一种安全防范的有效手段

**木马的防范**

1. **及时修补漏洞，安装补丁**：操作系统、浏览器和其他常用软件经常会发现安全漏洞，这些漏洞往往是木马入侵的通道。因此，定期检查并安装软件更新和安全补丁至关重要。这能有效封堵安全漏洞，减少被木马利用的风险。
2. **运行实时监控程序**：安装并启用一款可靠的安全软件，如防病毒软件或互联网安全套件，这些软件通常包含实时监控功能，能够持续扫描系统，检测并阻止木马等恶意软件的活动。确保安全软件保持最新，以便能够防御最新的威胁。
3. **培养风险意识，不使用来历不明的软件**：用户应该养成良好的网络卫生习惯，避免下载和安装未经验证的软件，特别是来自不可信网站、邮件附件或P2P网络的文件。只从官方网站或经过认证的平台获取软件，并确认下载链接的真实性。
4. **即时发现，即时清除**：一旦发现系统有异常行为，如无故变慢、出现未知进程、网络流量异常增加等，应立即使用安全软件进行全面扫描，并按照提示清除发现的威胁。对于难以清除的顽固木马，可能需要进入安全模式或使用专业的反木马工具进行处理。



### 木马的发展趋势

1. **跨平台**：早期木马往往针对特定操作系统或平台设计，但现在越来越多的木马采用跨平台技术，能够感染Windows、macOS、Linux、Android、iOS等多种操作系统，甚至是物联网设备，极大地扩展了其潜在的攻击范围。
2. **模块化设计**：模块化设计使得木马更加灵活和可扩展。木马被分解成多个功能模块，如信息窃取、远程控制、传播、自我隐藏等，每个模块可以独立更新或替换，使得木马能够快速适应新的攻击策略或绕过最新的安全防御措施。
3. **无连接木马**：传统的木马需要与C&C（命令与控制）服务器建立明确的连接来接收指令，而无连接木马则减少或不依赖直接的网络连接，采用更隐蔽的通信方式，如利用社交媒体、合法的Web服务或P2P网络作为指令传递的渠道，以减少被发现的风险。
4. **主动植入**：木马的植入技术从被动等待用户操作激活转向主动攻击，利用自动化工具和脚本、零日漏洞利用、供应链攻击等方法直接将木马植入目标系统，降低了对用户交互的依赖，提高了成功率。
5. **木马与病毒的融合**：以往木马和病毒被视为不同类型的恶意软件，但现在的趋势是两者融合，形成复合型威胁。木马可能携带病毒功能，如自我复制和传播机制，或者病毒携带木马的控制模块，使得单一恶意软件具备多重攻击能力，更难于清除和防御。
